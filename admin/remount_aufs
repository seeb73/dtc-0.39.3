#!/bin/sh
#
# This script does an umount call for each folder that needs to be
# unmounted, and an mount call whenever a new virtualhost is active.
# It does that by comparing /proc/mounts and /var/lib/dtc/etc/aufs_list
# which is generated by DTC.
#
# If for some reason you need to umount everything, you can do:
# for i in `cat /proc/mounts | grep aufs | cut -d" " -f2 | more` ; do umount $i ; done
# which will umount all aufs mounts present in the system
#
# Note that since this script is checking against all mounted AUFS,
# you cannot use AUFS for anything else than DTC.
# An ignore list should be implemented to avoid such an issue, but
# for the moment, I have no time to implement it.

set -e

if [ "${1}" = -q ] ; then
	VERBOSE=0
else
	VERBOSE=1
fi

echoIfVerbose () {
	if [ "${VERBOSE}" = "1" ] ; then
		echo $1
	fi
}

echoIfVerbose "Computing lists of mounts and unmounts..."

## Compute list of already mounted subdomains.aufs/XXX
SORTED_MOUNTED_LIST_FILE=`mktemp -t DTC_MOUNTED_LIST_FILE.XXXXXX`
grep " aufs " /proc/mounts|cut -d" " -f2|sort >>${SORTED_MOUNTED_LIST_FILE}

# Compute list of subdomains.aufs/XXX that we would like to see mounted
SORTED_TOMOUNT_LIST_FILE=`mktemp -t DTC_SORTED_TOMOUNT_LIST_FILE.XXXXXX`
awk -F"subdomains" '{print $1 "subdomains.aufs" $2}' /var/lib/dtc/etc/aufs_list | sort  >>${SORTED_TOMOUNT_LIST_FILE}

# Compute differences beetween lists
UMOUNT_LIST=`comm -23 ${SORTED_MOUNTED_LIST_FILE} ${SORTED_TOMOUNT_LIST_FILE}`
MOUNT_LIST=`comm -13 ${SORTED_MOUNTED_LIST_FILE} ${SORTED_TOMOUNT_LIST_FILE}`

# Umount what's needed
echoIfVerbose "umount list:"
for i in ${UMOUNT_LIST} ; do
	echoIfVerbose umount ${i}
	umount ${i} || true
done

# Mount what's not mounted yet
echoIfVerbose "mount list:"
for i in ${MOUNT_LIST} ; do
	SUBDOMAIN=`basename ${i}`
	TMP=`dirname ${i}`
	TARGET=`dirname ${TMP}`/subdomains.aufs/${SUBDOMAIN}
	SOURCE=`dirname ${TMP}`/subdomains/${SUBDOMAIN}
	echoIfVerbose "mount -t aufs -o br:${SOURCE}=rw:/var/lib/dtc/sbox_copy=ro none ${TARGET}"
	mount -t aufs -o br:${SOURCE}=rw:/var/lib/dtc/sbox_copy=ro none ${TARGET} || true
done
rm ${SORTED_MOUNTED_LIST_FILE} ${SORTED_TOMOUNT_LIST_FILE}
